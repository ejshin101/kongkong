<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
<script type="text/javascript"
	src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.5/sockjs.min.js"></script>
<style>
#messageArea{
height: 400px;
width:  380px;
overflow: auto;
}
#message{
width: 300px
}
.messageBox{
position: absolute;
height: 440px;
width:  380px;
border: 1px solid;
border-radius: 5px;
border-color: #2493e0;
}
.message{
border-top: 2px solid;
border-top-color: #2493e0;
}
.myText{
text-align: right;
}
.myText span{
border-radius : 20px;
background-color:#c8f0fd;

}
.othersText{
text-align: left;
}
.othersText span{
border-radius : 10px;
background-color: #fdf3b9;
}

</style>
</head>
<body>

<div class="messageBox">
<div id="messageArea">
<c:forEach items="${chat}" var="chat">
<c:if test="${chat.chatId eq sessionScope.USER_INFO.userName}">
<div class='myText'><span>나: ${chat.text}</span></div>
</c:if>
<c:if test="${chat.chatId ne sessionScope.USER_INFO.userName}">
<div class='othersText'><span>${chat.chatId}: ${chat.text}</span></div>
</c:if>
</c:forEach>
</div>
<div class="message">
<c:if test="${not empty sessionScope.USER_INFO}">
<input type="text" id="message" onkeydown="enter()"/>
<input type="button" id="sendBtn" value="전송!"/>
</c:if>
<c:if test="${empty sessionScope.USER_INFO}">
	<a href="<%=request.getContextPath()%>/login/login.wow">로그인</a>시 채팅서비스를 사용할 수 있습니다.  </c:if>
</div>
</div><!--  messageBox end -->

<script type="text/javascript">
$(document).ready(
        function() {
          var scrollSpy = new bootstrap.ScrollSpy(document.body, {
            target : '.messageBox'
          })
          scrollSpy.addEventListener('activate.bs.scrollspy', function(dataSpyEl){
            bootstrap.ScrollSpy.getInstance(dataSpyEl).refresh();
          });
        });
  
    $(window).scroll(function() {
      var scrollTop = $(document).scrollTop() + 200;
      if (scrollTop < 200) {
        scrollTop = 200;  //시작지점이 200
      }
      
      $(".messageBox").stop();
      $(".messageBox").animate({
        "top" : scrollTop
      });
    });


	$("#sendBtn").click(function() {
		sendMessage();
		$('#message').val('')
	});
	
	let sock = new SockJS("<%=request.getContextPath()%>/chatting/");
	sock.onmessage = onMessage;
	sock.onclose = onClose;
	sock.onopen = onOpen;
	// 메시지 전송
	function sendMessage() {
		sock.send($("#message").val());
	}
	// 서버로부터 메시지를 받았을 때
	function onMessage(msg) {
		var data = msg.data;
		var arr = data.split(":");
		var myName='${sessionScope.USER_INFO.userName}';
		if(myName ==arr[0]){
		$("#messageArea").append("<div class='myText'><span>나: "+arr[1] + "</span></div>");
		}else{
		$("#messageArea").append("<div class='othersText'><span>"+data + "</span></div>");
		}
		
		$('#messageArea').scrollTop($('#messageArea').prop('scrollHeight'));
	}
	// 서버와 연결을 끊었을 때
	function onClose(evt) {
		$("#messageArea").append("연결이 끊겼습니다.");

	}
	function onOpen(evt) {
		$("#messageArea").append("입장<br>");

	}
	function enter(){
	     if(window.event.keyCode == 13){
	    	 sendMessage();
	    	 $('#message').val('');
	     } 
	}
</script>
</body>
</html>