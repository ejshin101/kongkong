<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
<script type="text/javascript"
	src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.5/sockjs.min.js"></script>
<style>
  @import url(//fonts.googleapis.com/earlyaccess/nanumpenscript.css);
    @import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo&display=swap');
#messageArea{
height: 430px;
width:  357px;
overflow: auto;
}
#message{
width: 300px;
}
#chatbot{
bottom: 1px;
right : 30px;
position: fixed;
z-index: 10;
}

.messageBox{
visibility:hidden;
bottom: 200px;
right : 30px;
position: fixed;
height: 500px;
width:  357px;
border: 1px solid;
border-radius: 5px;
border-color: #2493e0;
z-index: 10;
background-color: #A3C9F2;
font-family: "Nanum Myeongjo",serif;
}
.message{
border-top: 2px solid;
border-top-color: #2493e0;
}
.myText{
text-align: right;
margin-top: 3px;
padding-right: 4px;
}
.myText .text{
padding-left: 3px;
padding-right: 3px;
border-radius : 20px;
background-color:#fdf3b9;
font-size: 20px;
}
.othersText{
left: 3px;
text-align: left;
margin-top: 3px;
padding-left: 10px;
}
.othersText .text{
padding-left: 3px;
padding-right: 3px;
border-radius : 10px;
background-color: white;
font-size: 20px;
}

.curTime{
font-size: small;
background-color: #A3C9F2;
}
.chatBtn{
display: inline-block;
  color: black;
  background-color: #A3C9F2;
  border : 0;
}
#flyingObject{
visibility: hidden;
position: absolute;
width: 100px;
height: 100px;
z-index: 100;
overflow:hidden;
border-radius: 30px;
}
@keyframes marqueeX {
  from { left: 0; } to { left:90%; }
}
@keyframes marqueeY {
  from { top: 0; } to { top: 100%; }

</style>
</head>
<body>
<img src="<%=request.getContextPath() %>/resources/image/logo.jpg" id="flyingObject">

<div class="messageBox">
<div id="messageArea">

</div>
<div class="message">
<c:if test="${not empty sessionScope.USER_INFO}">
<input type="button" id="fontBtn" class="chatBtn" value="폰트변경"/>
<input type="button" id="size" class="chatBtn" value=""/>
<input type="text" id="message"  onkeydown="enter()"/>
<input type="button" id="sendBtn" class="chatBtn" value="전송"/>
</c:if>
<c:if test="${empty sessionScope.USER_INFO}">
	<a href="<%=request.getContextPath()%>/login/login.wow">로그인</a>시 채팅서비스를 사용할 수 있습니다.  </c:if>
</div>
</div><!--  messageBox end -->
<a id="chatbot" onclick="fn_chat()"> 
	<img src="<%=request.getContextPath()%>/resources/image/chat.png " alt=""
	style="width: 100px; height:150px; padding-bottom: 50px">
</a>
<script type="text/javascript">
window.onload = function(){
	flyingObjectHidden();
}
function fly() {
	$('#flyingObject').css('visibility','visible');
	var top = parseInt( Math.random() * 2000);
    var left = parseInt( Math.random() * 1400);
    $('#flyingObject').css({top: top,left: left});
	}
function flyingObjectHidden() {
	var Waiting = parseInt( Math.random() * 60000); // 나타나는 시간
	window.setTimeout(fly,Waiting);
}
$('#flyingObject').click(function(){
	if('${sessionScope.USER_INFO.userId}' == ''){
  $('#flyingObject').css('visibility','hidden');
  flyingObjectHidden();
  alert('로그인을 해주세요');
}else{
	$('#flyingObject').css('visibility','hidden');
	$.ajax({
		type :"GET",
		url : "<c:url value='/event/mileagecheck'/>",	
		dataType : 'json',
		data : {
			memId:'${sessionScope.USER_INFO.userId}',
			requiredMileage: 0
		},		
		success :function(data){
			if(data.result){
			var	curMileage = data.curMileage;
			var randomMileage= Math.floor(Math.random() * 10)*1000;
			  $.ajax({
						type :"GET",
						url : "<c:url value='/event/mileage'/>",	
						data : {
							memId:'${sessionScope.USER_INFO.userId}',
							memMileage: curMileage+randomMileage
						},		
						success :function(data){
							alert(randomMileage+"마일리지 획득!");
							 Mymileage();	
							 flyingObjectHidden();
						}
						});  
			};
			}
		});  // mileage check ajax --end
}; //else 끝
})


	var chat =2;
	function fn_chat(){
	if(chat==1){
		$('.messageBox').css('visibility','hidden')
	chat=2;
	}else{
		$('.messageBox').css('visibility','visible')
	chat=1;		
		}
	};

	$("#sendBtn").click(function() {
		sendMessage();
		$('#message').val('')
	});
	
	let sock = new SockJS("<%=request.getContextPath()%>/chatting/");
	sock.onmessage = onMessage;
	sock.onclose = onClose;
	sock.onopen = onOpen;
	// 메시지 전송
	function sendMessage() {
		sock.send($("#message").val());
	}
	// 서버로부터 메시지를 받았을 때
	function onMessage(msg) {
		var data = msg.data;
		var arr = data.split("-");
		var clock = arr[2].split(":");
		var msg = (clock[0]%12)+"시";
		msg+= clock[1]+"분";
		if(clock[0]>=12){
			msg +="PM";
        }else{
        msg +="AM";
        } ;
		var myName='${sessionScope.USER_INFO.userName}';
		if(myName ==arr[0]){
			if(arr[1]!=null){
		$("#messageArea").append("<div class='myText'><span class='curTime'>"+msg+"</span><span class='text'>"+arr[1] + "</span></div>");
			}
		}else{
			if(arr[1] == null){
		$("#messageArea").append("<div>"+arr[0]+"</div>");
			}else{
		$("#messageArea").append("<div>"+arr[0]+"</div><div class='othersText'><span class='text'>"+arr[1] + "</span><span class='curTime'>"+msg+"</span></div>");
			};
		}
		
		$('#messageArea').scrollTop(9999999);
	}
	// 서버와 연결을 끊었을 때
	function onClose(evt) {
		$("#messageArea").append("연결이 끊겼습니다.");

	}
	function onOpen(evt) {
		$("#messageArea").append("채팅방에 연결되었습니다<br>");

	}
	function enter(){
	     if(window.event.keyCode == 13){
	    	 sendMessage();
	    	 $('#message').val('');
	     } ;
	}
	 var font =1;
	$("#fontBtn").click(function() {
	    if(font==1){
	        $('.messageBox').css('font-family','"Nanum Pen Script", cursive');
	        $('.myText .text').css(' font-size','24px');
	        $('.othersText .text').css('font-size','24px');
	        font=2;
	    }else if(font==2){
	        $('.messageBox').css('font-family','"Nanum Myeongjo",serif');
	        $('.myText .text').css(' font-size','20px');
	        $('.othersText .text').css('font-size','20px');
	        font=1;
	    };
	});
</script>
</body>
</html>